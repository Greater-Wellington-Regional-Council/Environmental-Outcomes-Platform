include:
  - ../LocalInfrastructure/batect-shared.yml

tasks:
  deps:
    description: Install DBT deps
    run:
      container: dbt-env
      command: deps --profiles-dir /usr/app

  lint:
    description: Run SQLfluff against the codebase
    dependencies:
      - test-database
    run:
      container: fluff-env
      command: lint ./

  lint-fix:
    description: Run SQLfluff against the codebase
    dependencies:
      - test-database
    run:
      container: fluff-env
      command: fix ./

  test:
    description: Run DBT tests against the local DB
    dependencies:
      - test-database
    run:
      container: dbt-env
      command: build --profiles-dir /usr/app/dbt --target test

  run:
    description: Run DBT against the local env
    run:
      container: dbt-env
      command: run --profiles-dir /usr/app/dbt --target dev

containers:
  dbt-env:
    image: ghcr.io/dbt-labs/dbt-postgres:1.5.8
    volumes:
      - local: <{batect.project_directory}
        container: /usr/app/dbt

  fluff-env:
    build_directory: .batect/sqlfluff
    volumes:
      - local: <{batect.project_directory}
        container: /usr/app/dbt
