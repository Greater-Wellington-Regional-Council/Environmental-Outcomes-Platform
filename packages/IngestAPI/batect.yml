project_name: nz-govt-eop-ingest-api

tasks:
  build:
    description: Build the application.
    run:
      container: java-build-env
      command: ./gradlew bootJar

  check:
    description: Run tests and checks.
    run:
      container: java-build-env
      command: ./gradlew check --console=verbose

  runIngestAPI:
    description: Run the application.
    prerequisites:
      - build
    run:
      container: ingest-api-service
      ports:
        - 8080:8080

  shell:
    description: Start a shell in the development environment.
    run:
      container: java-build-env
      command: bash

  runSupportServices:
    description: Run all services required for local development
    run:
      container: kafka-ui

containers:
  ingest-api-service:
    build_directory: ./

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181

  kafka:
    image: confluentinc/cp-kafka:latest
    dependencies:
      - zookeeper
    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    dependencies:
      - kafka
    ports:
      - 8081:8080
    environment:
      KAFKA_CLUSTERS_0_NAME: kafka
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092

include:
  - type: git
    repo: https://github.com/batect/java-bundle.git
    ref: 0.6.0
